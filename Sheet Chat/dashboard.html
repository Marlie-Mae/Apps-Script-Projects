<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
   body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #ece5dd;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* HEADER - Made taller and fonts larger */
    .header {
      background: #075e54;
      color: white;
      padding: 18px 25px; /* Increased padding */
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-weight: bold;
    }

    .header .title {
      font-size: 24px; /* Increased from 18px */
    }

    .header .user-avatar {
      background: #25d366;
      width: 48px;  /* Increased from 36px */
      height: 48px; /* Increased from 36px */
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px; /* Larger letter */
      font-weight: bold;
      cursor: pointer;
    }

    /* SEARCH - Larger input */
    .search {
      background: #f0f0f0;
      padding: 15px; /* Increased padding */
    }

    .search input {
      width: 97%;
      padding: 12px 20px; /* Larger touch area */
      border-radius: 25px;
      border: none;
      outline: none;
      font-size: 16px; /* Increased from 14px */
    }

    /* CHAT LIST */
    .chat-list {
      flex: 1;
      overflow-y: auto;
      background: #fff;
    }

    .chat-item {
      display: flex;
      align-items: center;
      padding: 18px 25px; /* Larger items */
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    .chat-item:hover {
      background: #f5f5f5;
    }

    .avatar {
      width: 56px;  
      height: 56px; 
      border-radius: 50%;
      background: #dcf8c6;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 20px;
      margin-right: 18px; 
      color: #075e54;
    }

    .chat-info {
      flex: 1;
    }

    .chat-name {
      font-weight: bold;
      font-size: 18px;
      margin-bottom: 4px;
    }

    .chat-preview {
      font-size: 15px; 
      color: #666;
    }

    .user-menu {
      position: relative;
    }

    .dropdown {
      position: absolute;
      right: 0;
      top: 52px; /* Adjusted for larger header */
      background: white;
      color: black;
      min-width: 200px; /* Wider dropdown */
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      display: none;
      z-index: 1000;
    }

    .dropdown.show {
      display: block;
    }

    .dropdown-username {
      padding: 15px;
      font-size: 16px;
      font-weight: bold;
      border-bottom: 1px solid #eee;
    }

    .dropdown-item {
      padding: 15px;
      font-size: 16px;
      cursor: pointer;
    }

    .dropdown-item:hover {
      background: #f5f5f5;
    }
  </style>
</head>

<body>

  <!-- HEADER -->
  <div class="header">
    <div class="title">SheetChat</div>

    <div class="user-menu" id="userMenu">
      <div class="user-avatar" id="userAvatar">?</div>

      <div class="dropdown" id="userDropdown">
        <div class="dropdown-username" id="dropdownUsername">Username</div>
        <div class="dropdown-item" id="logoutBtn">Logout</div>
      </div>
    </div>

  </div>

  <!-- SEARCH -->
  <div class="search">
    <input type="text" id="search" placeholder="Search or start new chat">
  </div>

  <!-- CHAT LIST -->
  <div class="chat-list" id="chatList">
    Loading chats...
  </div>

<script>
  let loggedInUser = null;
  let allUsers = [];
  let unreadCounts = {};
  let unreadTimer = null;
  let onlineStatus = {};
  let presenceTimer = null;

  window.addEventListener("userLoggedIn", () => {
    loggedInUser = window.currentUser;
    document.getElementById("userAvatar").textContent =
      loggedInUser.username.charAt(0).toUpperCase();
    loadUsers();

      document.getElementById("dropdownUsername").textContent =
    loggedInUser.username;

    // auto-refresh unread badges
    if (unreadTimer) clearInterval(unreadTimer);
    unreadTimer = setInterval(refreshUnreadCounts, 3000);

   if (presenceTimer) clearInterval(presenceTimer);

    presenceTimer = setInterval(() => {
      if (window.currentUser) {
        google.script.run.updateLastSeen(
          window.currentUser.username
        );
      }
    }, 5000);
    
  });

  function loadUsers() {
    google.script.run.withSuccessHandler(function(users) {

      google.script.run.withSuccessHandler(function(counts) {
        unreadCounts = counts || {};
        allUsers = users;
        renderUsers(users);
      }).getUnreadCount(loggedInUser.username);

    }).getOtherUsers(loggedInUser.userId);
  }


  function renderUsers(users) {
    const list = document.getElementById("chatList");
    list.innerHTML = "";
    

    if (users.length === 0) {
      list.innerHTML = "<em style='padding:12px'>No chats yet</em>";
      return;
    }

    users.forEach(u => {
      const div = document.createElement("div");
      div.className = "chat-item";
      div.onclick = () => openChat(u);

      div.innerHTML = `
        <div style="position:relative">
          <div class="avatar">
            ${u.username.charAt(0).toUpperCase()}
          </div>

          <span style="
            position:absolute;
            bottom:2px;
            right:10px;
            width:12px;
            height:12px;
            border-radius:50%;
            background:${onlineStatus[u.username] ? '#25d366' : '#ccc'};
            border:2px solid white;
          "></span>
        </div>

        <div class="chat-info">

        <div class="chat-name">
        ${u.username}
        ${unreadCounts[u.username]
          ? `<span style="
              background:#25d366;
              color:white;
              padding:3px 8px;
              border-radius:14px;
              font-size:13px;
              margin-left:8px;">
              ${unreadCounts[u.username]}
            </span>`
          : ""
        }
      </div>

          <div class="chat-preview">Tap to chat</div>
        </div>
      `;

      list.appendChild(div);
      
    });
  }

function openChat(user) {
  window.selectedChatUser = user;

  google.script.run.markMessagesAsRead(
    window.currentUser.username,
    user.username
  );

  // hide dashboard, show chat
  document.getElementById("dashboard").style.display = "none";
  document.getElementById("chat").style.display = "block";

  // tell chat who is talking to whom
  if (window.openChatRoom) {
    window.openChatRoom(
      window.currentUser.username,
      user.username
    );
  }

  // clear badge visually
    unreadCounts[user.username] = 0;
    renderUsers(allUsers);
  }


  document.getElementById("search").addEventListener("input", function () {
    const q = this.value.toLowerCase();
    const filtered = allUsers.filter(u =>
      u.username.toLowerCase().includes(q)
    );
    renderUsers(filtered);
  });

  function refreshUnreadCounts() {
    if (!loggedInUser) return;

    google.script.run.withSuccessHandler(function(counts) {
      unreadCounts = counts || {};
      renderUsers(allUsers);
    }).getUnreadCount(loggedInUser.username);

    google.script.run.withSuccessHandler(function(status) {
      onlineStatus = status || {};
      renderUsers(allUsers);
    }).getOnlineStatus();

  }

  document.getElementById("userAvatar").addEventListener("click", function (e) {
  e.stopPropagation();
  document.getElementById("userDropdown").classList.toggle("show");
});

document.addEventListener("click", function () {
  document.getElementById("userDropdown").classList.remove("show");
});

document.getElementById("logoutBtn").addEventListener("click", logout);

function logout() {
  if (presenceTimer) clearInterval(presenceTimer);

  google.script.run.updateLastSeen(
  window.currentUser.username
);

  if (unreadTimer) clearInterval(unreadTimer);

  window.currentUser = null;
  window.selectedChatUser = null;
  unreadCounts = {};
  allUsers = [];

  google.script.run.logoutUser();

  document.getElementById("userMenu").style.display = "none";
  document.getElementById("dashboard").style.display = "none";
  document.getElementById("chat").style.display = "none";

  document.getElementById("username").value = "";
  document.getElementById("password").value = "";

  // show login
  document.getElementById("login").style.display = "flex";
}

</script>

</body>
</html>
